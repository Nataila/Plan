// Generated by CoffeeScript 1.9.2
(function() {
  "use strict";
  var todoApp;

  angular.module('todoApp.services', []).factory('TodoService', function($http, $location) {
    return {
      send: function(url, par) {
        return $http.get(url, {
          params: par
        });
      },
      get_default_data: function($scope, url, par) {
        this.send(url, par).success(function(data) {
          $scope.data = data;
        });
      },
      change_status: function($scope, url, par) {
        this.send(url, par).success(function() {
          angular.forEach($scope.data, function(item) {
            if (item.id === par.sid) {
              item.status = par.status;
            }
          });
        });
      },
      del: function($scope, url, par) {
        this.send(url, par).success(function(data) {
          angular.forEach($scope.data, function(item) {
            var index;
            if (item.id === par.sid) {
              index = $scope.data.indexOf(item);
              $scope.data.splice(index, 1);
            }
          });
        });
      },
      getAddr: function() {
        var path, pathDict;
        pathDict = {
          '/plan/day': '日计划',
          '/plan/week': '周计划',
          '/plan/month': '月计划'
        };
        path = $location.path();
        return pathDict[path];
      },
      save: function($scope, url, par) {
        this.send(url, par).success(function(data) {
          $scope.data.unshift({
            id: data.id,
            content: par.content,
            status: false,
            type: par.type,
            time: data.time
          });
          $scope.pushData = '';
        });
      },
      drawPie: function(chartData) {
        return {
          chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
          },
          title: {
            text: 'Plan完成情况'
          },
          tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
          },
          plotOption: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              dataLabels: {
                enabled: true,
                color: '#000000',
                connectorColor: '#000000',
                format: '<b>{series.name}</b> {point.percentage:.1f} %'
              }
            }
          },
          series: [
            {
              type: 'pie',
              name: '我的plan',
              data: chartData
            }
          ]
        };
      }
    };
  });

  todoApp = angular.module('todoApp', ['ui.router', 'todoApp.services']);

  todoApp.config(function($httpProvider, $interpolateProvider) {
    $interpolateProvider.startSymbol('[[').endSymbol(']]');
    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
  });

  todoApp.config(function($stateProvider, $urlRouterProvider) {
    $urlRouterProvider.otherwise('/plan');
    $stateProvider.state('plan', {
      url: '/plan',
      templateUrl: 'plan.html',
      controller: 'HomeCtrl'
    }).state('plan.day', {
      url: '/day',
      templateUrl: 'plan/detail',
      controller: 'DayCtrl'
    }).state('plan.week', {
      url: '/week',
      templateUrl: 'plan/detail',
      controller: 'WeekCtrl'
    }).state('plan.month', {
      url: '/month',
      templateUrl: 'plan/detail',
      controller: 'MonthCtrl'
    });
  });

  todoApp.controller('todoCtrl', function($scope, TodoService) {
    return $('.try').on('click', function() {
      $('.left.sidebar').sidebar({
        dimPage: false,
        closable: false
      }).sidebar('toggle');
    });
  });

  todoApp.controller('HomeCtrl', function($scope) {});

  todoApp.directive('sidebarSwitch', function() {
    return {
      link: function(scope, elem, attrs) {
        elem.bind('click', function() {
          $('.sidebar').sidebar({
            dimPage: false,
            transition: 'overlay'
          }).sidebar('toggle');
        });
        return elem.bind('mouseover', function() {
          return elem.transition('pulse');
        });
      }
    };
  });

  todoApp.controller('DayCtrl', function($scope, $http, $location, TodoService) {
    $scope.addr = TodoService.getAddr();
    $scope.statusChange = function(sid, status) {
      TodoService.change_status($scope, 'change_status', {
        'sid': sid,
        'status': status
      });
    };
    $scope["delete"] = function(sid) {
      return TodoService.del($scope, 'delete', {
        'sid': sid
      });
    };
    $scope.send = function() {
      var sendData;
      sendData = {
        'content': $scope.pushData,
        'type': 'day'
      };
      TodoService.save($scope, 'save', sendData);
    };
  });

  todoApp.controller('WeekCtrl', function($scope, $http, $location, TodoService) {
    $scope.addr = TodoService.getAddr();
    TodoService.get_default_data($scope, 'get_default_data', {
      'type': 'week'
    });
    $scope.statusChange = function(sid, status) {
      TodoService.change_status($scope, 'change_status', {
        'sid': sid,
        'status': status
      });
    };
    $scope["delete"] = function(sid) {
      return TodoService.del($scope, 'delete', {
        'sid': sid
      }, 'day');
    };
    $scope.send = function() {
      var sendData;
      sendData = {
        'content': $scope.pushData,
        'type': 'week'
      };
      TodoService.save($scope, 'save', sendData);
    };
  });

  todoApp.controller('MonthCtrl', function($scope, $http, $location, TodoService) {
    $scope.addr = TodoService.getAddr();
    TodoService.get_default_data($scope, 'get_default_data', {
      'type': 'month'
    });
    $scope.statusChange = function(sid, status) {
      TodoService.change_status($scope, 'change_status', {
        'sid': sid,
        'status': status
      });
    };
    $scope["delete"] = function(sid) {
      return TodoService.del($scope, 'delete', {
        'sid': sid
      });
    };
    $scope.send = function() {
      var sendData;
      sendData = {
        'content': $scope.pushData,
        'type': 'month'
      };
      return TodoService.save($scope, 'save', sendData);
    };
  });

  todoApp.directive('planProgress', function($http, $location) {
    return {
      scope: false,
      link: function(scope, elem, attrs) {
        var get_type;
        get_type = $location.path().split('/')[2];
        scope.path = get_type;
        $http.get('get_default_data', {
          params: {
            'type': get_type
          }
        }).then(function(data) {
          scope.percentCount = function(data) {
            var percent, truecount;
            truecount = percent = 0;
            angular.forEach(data, function(item) {
              if (item.status) {
                truecount += 1;
              }
            });
            return percent = (truecount / data.length).toFixed(3) * 100;
          };
          scope.data = data.data;
          scope.done = scope.percentCount(scope.data);
          scope.$watch('data', function() {
            elem.progress({
              percent: scope.percentCount(scope.data)
            });
          }, true);
        });
      }
    };
  });

  todoApp.directive('drawPie', function($http, TodoService) {
    return {
      scope: false,
      link: function(scope, elem, attrs) {
        TodoService.send('drawpie').then(function(data) {
          return elem.highcharts(TodoService.drawPie(data.data));
        });
      }
    };
  });

  todoApp.directive('dropDown', function() {
    return {
      link: function(scope, elem, attrs) {
        return elem.dropdown({
          on: 'hover'
        });
      }
    };
  });

  todoApp.directive('addAnimate', function() {
    return {
      link: function(scope, elem, attrs) {
        return elem.transition({
          animation: 'bounce',
          duration: '1500ms'
        });
      }
    };
  });

  todoApp.directive('setFocus', function() {
    return {
      link: function(scope, elem, attrs) {
        return elem.focus();
      }
    };
  });

  todoApp.directive('listDirective', function() {
    return {
      link: function(scope, elem, attrs) {
        return elem.transition({
          animation: 'drop',
          duration: '1500ms'
        });
      }
    };
  });

}).call(this);
